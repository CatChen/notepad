<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8">
	<title>Notepad</title>
	<script type="text/javascript" src="javascripts/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="javascripts/underscore.js"></script>
	<script type="text/javascript" src="javascripts/backbone.js"></script>
	<script type="text/javascript" src="javascripts/polyfill.js"></script>
	<script type="text/javascript" src="javascripts/models.js"></script>
	<script type="text/javascript">
$(function() {
    /* data transfer property is needed in drag and drop events */
    $.event.props.push('dataTransfer');
    
    $('.dropZone').on('dragover', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        e.dataTransfer.dropEffect = 'copy';
    });
    
    $('.dropZone').on('drop', function(e) {
        if (e.dataTransfer.files.length === 0) {
            /* stop file drop handling when there is no file */
            return;
        }
        
        e.stopPropagation();
        e.preventDefault();
        
        var files = e.dataTransfer.files;
        for (var i = 0, l = files.length; i < l; i++) {
            (function(file) {
                console.log(file);
                var reader = new FileReader();
                
                reader.readAsText(file);
                
                reader.onload = function(e) {
                    console.log(e.target.result);
                    
                    root.add({
                        name: file.name,
                        size: file.size,
                        date: file.lastModifiedDate.getTime(),
                        content: e.target.result
                    });
                    
                    $('#editor').val(e.target.result);
                };
                
                reader.onerror = function(e) {
                    console.log('file reading error');
                    console.log(e);
                    console.log(file);
                };
                
                reader.onprogress = function(e) {
                    console.log('file reading progress');
                    console.log(e.loaded / e.total);
                };
            })(files[i]);
        }
    });
    
    $('#save').on('click', function(e) {
        if ($(this).attr('href') === '###') {
            e.stopPropagation();
            e.preventDefault();

            var builder = new BlobBuilder();
            builder.append($('#editor').val());
            var blob = builder.getBlob();
            var dataURL = URL.createObjectURL(blob);
            var clickEvent = document.createEvent("MouseEvent");
            clickEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            $(this).attr('href', dataURL);
            this.dispatchEvent(clickEvent);
            
            setTimeout(function() {
                URL.revokeObjectURL(dataURL);
                $('#save').attr('href', '###');
            }, 0);
        }
    });
});
	</script>
</head>
<body>
    <ul id="fileList" class="dropZone">
        <!--
        <li id="file_{{cid}}" title="{{date}}">{{name}}</li>
        -->
    </ul>
    <ul id="tabList">
        <!--
        <li id="tab_{{cid}}">{{name}}</li>
        -->
    </ul>
    <div id="editors">
        <!--
        <textarea id="editor_{{cid}}" class="editor"></textarea>
        -->
    </div>
	<!--<a id="save" href="###" download="test.txt">Save</a>-->
</body>
</html>
